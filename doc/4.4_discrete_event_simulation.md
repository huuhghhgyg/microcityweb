[< 4.3 Scene and Object](4.3_scene_and_object.md) | [Table of Contents](readme.md) | [4.5 Mixed Integer Programming >](4.5_mixed_integer_programming.md)

# 4.4 Discrete Event Simulation
In simulation, events need to be randomly generated and scheduled, so the random number and coroutine functions in Lua have been improved.

## Random Number Generation
The probability distribution of random numbers has been expanded, but the traditional usage is still maintained.

<a id='math.randomseed'> math.randomseed (x, [, disttab]) </a>

Return a seed according to the integer parameters x and the optional table of disttab. The options in disttab:
- dist: Probability distribution, one of "normal", "exponential", "poisson" and "uniform". Default is "uniform".
- mu: Mean or expected value. Default is 1.
- sigma: Standard deviation (only applicable for normal distribution). Default is 1.

<a id='math.random'> math.random ([seed|m [, n]]) </a>

When called without arguments, returns a uniform real number in the range [0,1). When called with an integer number m, returns a uniform integer in the range [1, m]. When called with two integer numbers m and n, returns a uniform integer in the range [m, n].
<br>When called with a **seed** generated from math.randomseed, returns a number follow the distribution specified by the seed. This usage can be rewritten to seed:random(). An example is shown below:
```
local seed = math.randomseed(1, {dist = "normal", mu = 5, sigma = 3})
for i = 1, 10 do
    print(seed:random())
end
```

## Event Scheduling
In discrete event simulation, events need to be scheduled in chronological order. In MicroCity Web, events are defined as Lua's coroutine (or function), so three new members are added to the coroutine library.

<a id='coroutine.queue'> coroutine.queue (rt, f|co [, arg1, ···]) </a>

Queue an event f (function) or co (coroutine) by relative time rt (>=0) for later execution. The values arg1, ... are passed as the arguments to the body function. 

<a id='coroutine.qtime'> coroutine.qtime () </a>

Return the current simulation time (queued time).

<a id='coroutine.qexec'> coroutine.qexec () </a>

Execute all events in chronological order. By default MicroCity Web will run this function at the end of script, but user can explicitly call it when necessary.

To demonstrate the M/M/1

```
local M = "Idle"
local Q = 0

function Arrive()
    Q = Q + 1
    local ta = math.random()*4 + 1
    coroutine.queue(ta, Arrive)
    if M == "Idle" then
        coroutine.queue(0, Load)
    end

    local t = coroutine.qtime()
    print("AGV arrive at time: ", t, " Q = ", Q)
end

function Load()
    M = "Busy"
    Q = Q - 1
    local ts = math.random() + 2
    coroutine.queue(ts, Unload)

    local t = coroutine.qtime()
    print("RMG load at time: ", t, " Q = ", Q)
end

function Unload()
    M = "Idle"
    if Q > 0 then
        coroutine.queue(0, Load)
    end

    local t = coroutine.qtime()
    print("RMG unload at time: ", t, " Q = ", Q)
end

coroutine.queue(0, Arrive)

```

[< 4.3 Scene and Object](4.3_scene_and_object.md) | [Table of Contents](readme.md) | [4.5 Mixed Integer Programming >](4.5_mixed_integer_programming.md)